<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Shader drop</title>
  <style>
    #demo-div {
      color: lightgrey;
      border-radius: 0.3rem;
    }

    #demo-div span,
    #demo-div #num-observed-events {
      color: black;
    }

    h1 {
      margin-top: 0.5rem;
    }

    h4 {
      margin-top: 0.66rem;
      font-size: 1.33rem;
    }

    #demo-div li {
      line-height: 21px;
    }

    #demo-div ul {
      margin-bottom: 0.66rem;
    }
  </style>
</head>

<body>
  <main role="main" class="container">

    <h1 align="left">Sensor access with shader cross</h1>
    <script id="vertexShader" type="x-shader/x-vertex">
      precision mediump float;
      uniform float time;
      uniform vec2 resolution;
      uniform vec3 dropPosition;
      void main()	{
          gl_Position = vec4(position, 1.0 );
          //gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
      precision mediump float;
      uniform vec2 resolution;
      uniform float time;
      uniform vec3 dropPosition;

      // Draw a circle at vec2 `pos` with radius `rad` and color `color`.
      
      vec4 circle(vec2 uv, vec2 pos, float rad, vec3 color) {
        float d = (length(pos - uv) - rad);
        float t = clamp(d, 0.0, 1.0);
        return vec4(color, 1.0 - t);
      }
      float circle2(in vec2 _st, in float _radius){
        vec2 dist = _st-vec2(0.5);
        return 1.-smoothstep(_radius-(_radius*0.01), _radius+(_radius*0.01), dot(dist,dist)*4.0);
      }

      vec4 sphere(vec2 uv, vec2 pos, float size, float intensity, vec3 color){
        float ratio = (resolution.x/resolution.y); 
        uv.x *= ratio;
        pos.x *= ratio;
        vec2 dist = (pos.xy-uv.xy) * size;
        float flash = 1./dot(dist,dist);
        vec4 newcolor = vec4(color * flash * intensity, 1.);
        //vec4 newcolor = vec4(color * intensity, 1.);
        return vec4(newcolor);
      }
      
      vec3 test(vec2 uv) {
        return vec3(uv.x, uv.y, 0.);
      }

      void main() {
        // center the shader
        vec2 st = (gl_FragCoord.xy /resolution.xy - vec2(0.5));
        
        vec4 color = vec4(0.5);
        color.a = 1.0;

        // color the frame so we can see that it takes up the whole screen.
        if (st.x > 0.99) {color.rgb = vec3(0,0,1);}
        if (st.x < 0.01) {color.rgb = vec3(1,0,0);}
        if (st.y > 0.99) {color.rgb = vec3(0,0,1);}
        if (st.y < 0.01) {color.rgb = vec3(1,0,0);}

        // make cross
        if (st.x > 0.45 && st.x < 0.55) {color.rgb = vec3(1,1,1);}
        if (st.y > 0.45 && st.y < 0.55) {color.rgb = vec3(1,1,1);}
        
        // make moving cross
        float x = dropPosition.x;
        float y = dropPosition.y;
        if (st.x > x-0.05 && st.x < x+0.05) {color.rgb = vec3(1,0,0);}
        if (st.y > y-0.05 && st.y < y+0.05) {color.rgb = vec3(0,1,0);}


        //vec4 drop = circle(st, vec2(0.5,0.5), 0.1, vec3(0,1,0) );
        //vec4 drop = sphere(st, vec2(0.5,0.5), 0.0000000001, 0.0001, vec3(0,1,0));
        
        //vec4 drop = vec4(vec3( circle2( vec2(st.x - (1.-x), st.y - (1.-y)) ,.1) ) , 1.0);
        vec4 drop = vec4( vec3( circle2( vec2(st.x-x/resolution.x, st.y), 0.1) ), 1.0);
        
        //color = vec4(test(st),1.);
        color = color + drop;
        
        gl_FragColor = color;
    }

   </script>

    <script type="module">
      import * as THREE from './build/three.module.js'
      console.log("hello");

      let scene, renderer, controls;
      var startTime;
      var uniforms, material, mesh;
      let camera;
      init();
      animate();
      startTime = Date.now();

      function init() {
        /* SETUP */
        camera = new THREE.Camera();
        camera.position.z = 1.;
        scene = new THREE.Scene();

        /* SHADER STUFF */
        uniforms = {
          time: { type: "f", value: 1.0 },
          resolution: { type: "v2", value: new THREE.Vector2() },
          dropPosition: { type: "v2", value: new THREE.Vector2() }
        };

        material = new THREE.ShaderMaterial({
          uniforms: uniforms,
          vertexShader: document.getElementById('vertexShader').textContent,
          fragmentShader: document.getElementById('fragmentShader').textContent
        });

        mesh = new THREE.Mesh(new THREE.PlaneGeometry(2,2), material);
        scene.add(mesh);

        uniforms.resolution.value.x = window.innerWidth;
        uniforms.resolution.value.y = window.innerHeight;
        uniforms.dropPosition.value.x = 0.5;
        uniforms.dropPosition.value.y = 0.5;
        /* END SHADER STUFF */

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        window.addEventListener('resize', onWindowResize, false);
      }

      function animate() {
        window.requestAnimationFrame(animate);
        render();
      }

      function render() {
        var elapsedMilliseconds = Date.now() - startTime;
        var elapsedSeconds = elapsedMilliseconds / 1000.;
        uniforms.time.value = 60. * elapsedSeconds;

        // set info
        var x = document.getElementById('Orientation_g').innerHTML;
        var y = document.getElementById('Orientation_b').innerHTML; 
        if (x != null && x < 90 && x > -90) {
          uniforms.dropPosition.value.x = clamp_map(x, -90, 90, 0, 1);;
        } 
        if (y != null && y < 90 && y > -90) {
          uniforms.dropPosition.value.y = clamp_map(y, 90, -90, 0, 1);;
        }

        // render static cam
        renderer.render(scene, camera);
      }

      function clamp_map(value, min1, max1, min2, max2) {
        let newVal =0.;
        newVal = min2 + (value - min1) * (max2 - min2) / (max1 - min1);
        if (newVal < min2) {newVal = min2;}
        if (newVal > max2) {newVal = max2;}
        return newVal;
      }
      
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        uniforms.resolution.value.x = window.innerWidth;
        uniforms.resolution.value.y = window.innerHeight;
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    </script>

    <div class="p-3 mb-2 bg-secondary" id="demo-div">
      <a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start the demo</a>
      <p style="margin-top:1rem;">Num. of datapoints: <span class="badge badge-warning"
          id="num-observed-events">0</span></p>

      <ul>
        <li>X-axis (&beta;): <span id="Orientation_b">0</span><span>&deg;</span></li>
        <li>Y-axis (&gamma;): <span id="Orientation_g">0</span><span>&deg;</span></li>
        <li>Z-axis (&alpha;): <span id="Orientation_a">0</span><span>&deg;</span></li>
      </ul>
      <!--
      <h4>Accelerometer</h4>
      <ul>
        <li>X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
        <li>Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
        <li>Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
        <li>Data Interval: <span id="Accelerometer_i">0</span><span> ms</span></li>
      </ul>

      <h4>Accelerometer including gravity</h4>
      <ul>
        <li>X-axis: <span id="Accelerometer_gx">0</span><span> m/s<sup>2</sup></span></li>
        <li>Y-axis: <span id="Accelerometer_gy">0</span><span> m/s<sup>2</sup></span></li>
        <li>Z-axis: <span id="Accelerometer_gz">0</span><span> m/s<sup>2</sup></span></li>
      </ul>

      <h4>Gyroscope</h4>
      <ul>
        <li>X-axis: <span id="Gyroscope_x">0</span><span>&deg;/s</span></li>
        <li>Y-axis: <span id="Gyroscope_y">0</span><span>&deg;/s</span></li>
        <li>Z-axis: <span id="Gyroscope_z">0</span><span>&deg;/s</span></li>
      </ul>
      -->
    </div>
  </main>


  <!-- PHONE MOVEMENT -->
  <script>
    function handleOrientation(event) {
      updateFieldIfNotNull('Orientation_a', event.alpha);
      updateFieldIfNotNull('Orientation_b', event.beta);
      updateFieldIfNotNull('Orientation_g', event.gamma);
      incrementEventCount();
    }

    function incrementEventCount() {
      let counterElement = document.getElementById("num-observed-events")
      let eventCount = parseInt(counterElement.innerHTML)
      counterElement.innerHTML = eventCount + 1;
    }

    function updateFieldIfNotNull(fieldName, value, precision = 10) {
      if (value != null)
        document.getElementById(fieldName).innerHTML = value.toFixed(precision);
    }

    function handleMotion(event) {
      updateFieldIfNotNull('Accelerometer_gx', event.accelerationIncludingGravity.x);
      updateFieldIfNotNull('Accelerometer_gy', event.accelerationIncludingGravity.y);
      updateFieldIfNotNull('Accelerometer_gz', event.accelerationIncludingGravity.z);

      updateFieldIfNotNull('Accelerometer_x', event.acceleration.x);
      updateFieldIfNotNull('Accelerometer_y', event.acceleration.y);
      updateFieldIfNotNull('Accelerometer_z', event.acceleration.z);

      updateFieldIfNotNull('Accelerometer_i', event.interval, 2);

      updateFieldIfNotNull('Gyroscope_z', event.rotationRate.alpha);
      updateFieldIfNotNull('Gyroscope_x', event.rotationRate.beta);
      updateFieldIfNotNull('Gyroscope_y', event.rotationRate.gamma);
      incrementEventCount();
    }


    let is_running = false;
    let demo_button = document.getElementById("start_demo");

    demo_button.onclick = function (e) {
      e.preventDefault();
      // Request permission for iOS 13+ devices
      if (
        DeviceMotionEvent &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        DeviceMotionEvent.requestPermission();
      }

      if (is_running) {
        //window.removeEventListener("devicemotion", handleMotion);
        window.removeEventListener("deviceorientation", handleOrientation);
        demo_button.innerHTML = "Start demo";
        demo_button.classList.add('btn-success');
        demo_button.classList.remove('btn-danger');
        is_running = false;
      } else {
        //window.addEventListener("devicemotion", handleMotion);
        window.addEventListener("deviceorientation", handleOrientation);
        document.getElementById("start_demo").innerHTML = "Stop demo";
        demo_button.classList.remove('btn-success');
        demo_button.classList.add('btn-danger');
        is_running = true;
      }
    };
  </script>
</body>

</html>

