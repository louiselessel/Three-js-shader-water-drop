<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title> Shader drop demo </title>
  <style>
    #demo-div {
      color: lightgrey;
      border-radius: 0.3rem;
    }

    #demo-div span,
    #demo-div #num-observed-events {
      color: black;
    }

    h1 {
      margin-top: 0.5rem;
    }

    h4 {
      margin-top: 0.66rem;
      font-size: 1.33rem;
    }

    #demo-div li {
      line-height: 21px;
    }

    #demo-div ul {
      margin-bottom: 0.66rem;
    }
  </style>
</head>

<body>
  <main role="main" class="container">
    <h1 align="left">Shader drop demo</h1>

    <script id="vertexShader" type="x-shader/x-vertex">

      varying vec2 vUv;
      uniform float time;
      uniform vec2 resolution;
      uniform vec2 dropPosition;
      uniform sampler2D textureIn;

      void main()	{
        //gl_Position = vec4(position, 1.0 );
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">

      varying vec2 vUv;

      uniform vec2 resolution;
      uniform float time;
      uniform vec2 dropPosition;
      //vec2 dropPosition = vec2(0.5,0.0);
      const float threshold = 0.01;
      float aRadius = 0.1;

      uniform sampler2D textureIn;
      


      vec3 uvMap(vec2 uv) {
        return vec3(uv.x, uv.y, 0.);
      }

      void main() {
        vec2 st = (gl_FragCoord.xy /resolution.xy) *.5;
        float dist = distance(dropPosition.xy, st.xy);
          
        vec3 color;


        if (dist > aRadius) {
          //color = vec3(uvMap(st)); // debug that mapping is correct
          //color = vec3(uvMap(vUv)); // debug that mapping is correct
          //color = vec3(uvMap(dropPosition)); // debug color mapping
          //color = vec3(0.0);
          color = texture2D(textureIn, vUv).rgb;
        }
        else {
          float d = dist / aRadius;
          //color = vec3(dist);
          color = mix(vec3(1.,1.,1.), vec3(0.0), step(1.0-threshold, d));
        }
        
        gl_FragColor = vec4(color, 1.0);
      }

   </script>

   <!-- THREE JS MODULE -->
    <script type="module">
      import * as THREE from './build/three.module.js'
      console.log("hello");

      let scene, renderer, controls;
      var startTime;
      var uniforms, material, mesh;
      let camera;
      //const textureIn = new THREE.TextureLoader().load( "./textures/Lorem_Ipsum_Univers55.png" );

      init();
      animate();
      startTime = Date.now();

      
      function init() {
        /* SETUP */
        camera = new THREE.Camera();
        camera.position.z = 1.;
        scene = new THREE.Scene();

        /* SHADER STUFF */
        uniforms = {
          time: { type: "f", value: 1.0 },
          resolution: { type: "v2", value: new THREE.Vector2() },
          dropPosition: { type: "v2", value: new THREE.Vector2() },
          textureIn: { type: "t", value: new THREE.TextureLoader().load( 'textures/Lorem_Ipsum_Univers55.png' ) }
        };

        
        //uniforms[ "textureIn" ].value.wrapS = uniforms[ "texture" ].value.wrapT = THREE.RepeatWrapping;

        material = new THREE.ShaderMaterial({
          uniforms: uniforms,
          vertexShader: document.getElementById('vertexShader').textContent,
          fragmentShader: document.getElementById('fragmentShader').textContent
        });

        mesh = new THREE.Mesh(new THREE.PlaneGeometry(2,2), material);
        scene.add(mesh);

        uniforms.resolution.value.x = window.innerWidth;
        uniforms.resolution.value.y = window.innerHeight;
        uniforms.dropPosition.value.x = 0.5;
        uniforms.dropPosition.value.y = 0.5;
        /* END SHADER STUFF */

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        window.addEventListener('resize', onWindowResize, false);
      }

      function animate() {
        window.requestAnimationFrame(animate);
        render();
      }

      function render() {
        var elapsedMilliseconds = Date.now() - startTime;
        var elapsedSeconds = elapsedMilliseconds / 1000.;
        uniforms.time.value = 60. * elapsedSeconds;

        // set info
        var x = document.getElementById('Orientation_g').innerHTML;
        var y = document.getElementById('Orientation_b').innerHTML; 
        var gyroVal = 60;
        if (x != null && x < gyroVal && x > -gyroVal) {
          var valx = clamp_map(x, -gyroVal, gyroVal, 0, 1);
          uniforms.dropPosition.value.x = valx;
          updateFieldIfNotNull('Mapped_X', valx);
        } 
        if (y != null && y < gyroVal && y > -gyroVal) {
          var valy = clamp_map(y, gyroVal, -gyroVal, 0, 1);
          uniforms.dropPosition.value.y = valy;
          updateFieldIfNotNull('Mapped_Y', valy);
        }

        // render static cam
        renderer.render(scene, camera);
      }


      function updateFieldIfNotNull(fieldName, value, precision = 10) {
        if (value != null)
          document.getElementById(fieldName).innerHTML = value.toFixed(precision);
      }

      function clamp_map(value, min1, max1, min2, max2) {
        let newVal = 0.;
        newVal = min2 + (value - min1) * (max2 - min2) / (max1 - min1);
        if (newVal < min2) {newVal = min2;}
        if (newVal > max2) {newVal = max2;}
        return newVal;
      }
      
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        uniforms.resolution.value.x = window.innerWidth;
        uniforms.resolution.value.y = window.innerHeight;
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    </script>

    <div class="p-3 mb-2 bg-secondary" id="demo-div">
      <a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start the demo</a>
      <p style="margin-top:1rem;">Num. of datapoints: <span class="badge badge-warning"
          id="num-observed-events">0</span></p>

      <ul>
        <li>X-axis (&beta;): <span id="Orientation_b">0</span><span>&deg;</span></li>
        <li>Y-axis (&gamma;): <span id="Orientation_g">0</span><span>&deg;</span></li>
        <li>Z-axis (&alpha;): <span id="Orientation_a">0</span><span>&deg;</span></li>
        
        <li>mapped X: <span id="Mapped_X">0</span></li>
        <li>mapped Y: <span id="Mapped_Y">0</span></li>
        
      </ul>
      <!--
      <h4>Accelerometer</h4>
      <ul>
        <li>X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
        <li>Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
        <li>Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
        <li>Data Interval: <span id="Accelerometer_i">0</span><span> ms</span></li>
      </ul>

      <h4>Accelerometer including gravity</h4>
      <ul>
        <li>X-axis: <span id="Accelerometer_gx">0</span><span> m/s<sup>2</sup></span></li>
        <li>Y-axis: <span id="Accelerometer_gy">0</span><span> m/s<sup>2</sup></span></li>
        <li>Z-axis: <span id="Accelerometer_gz">0</span><span> m/s<sup>2</sup></span></li>
      </ul>

      <h4>Gyroscope</h4>
      <ul>
        <li>X-axis: <span id="Gyroscope_x">0</span><span>&deg;/s</span></li>
        <li>Y-axis: <span id="Gyroscope_y">0</span><span>&deg;/s</span></li>
        <li>Z-axis: <span id="Gyroscope_z">0</span><span>&deg;/s</span></li>
      </ul>
      -->
    </div>
  </main>


  <!-- PHONE MOVEMENT -->
  <script>
    function handleOrientation(event) {
      updateFieldIfNotNull('Orientation_a', event.alpha);
      updateFieldIfNotNull('Orientation_b', event.beta);
      updateFieldIfNotNull('Orientation_g', event.gamma);
      incrementEventCount();
    }

    function incrementEventCount() {
      let counterElement = document.getElementById("num-observed-events")
      let eventCount = parseInt(counterElement.innerHTML)
      counterElement.innerHTML = eventCount + 1;
    }

    function updateFieldIfNotNull(fieldName, value, precision = 10) {
      if (value != null)
        document.getElementById(fieldName).innerHTML = value.toFixed(precision);
    }

    function handleMotion(event) {
      updateFieldIfNotNull('Accelerometer_gx', event.accelerationIncludingGravity.x);
      updateFieldIfNotNull('Accelerometer_gy', event.accelerationIncludingGravity.y);
      updateFieldIfNotNull('Accelerometer_gz', event.accelerationIncludingGravity.z);

      updateFieldIfNotNull('Accelerometer_x', event.acceleration.x);
      updateFieldIfNotNull('Accelerometer_y', event.acceleration.y);
      updateFieldIfNotNull('Accelerometer_z', event.acceleration.z);

      updateFieldIfNotNull('Accelerometer_i', event.interval, 2);

      updateFieldIfNotNull('Gyroscope_z', event.rotationRate.alpha);
      updateFieldIfNotNull('Gyroscope_x', event.rotationRate.beta);
      updateFieldIfNotNull('Gyroscope_y', event.rotationRate.gamma);
      incrementEventCount();
    }


    let is_running = false;
    let demo_button = document.getElementById("start_demo");

    // Button click will TO BE REMOVED

    demo_button.onclick = function (e) {
      e.preventDefault();
      // Request permission for iOS 13+ devices
      if (
        DeviceMotionEvent &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        DeviceMotionEvent.requestPermission();
      }

      if (is_running) {
        //window.removeEventListener("devicemotion", handleMotion);
        window.removeEventListener("deviceorientation", handleOrientation);
        demo_button.innerHTML = "Start demo";
        demo_button.classList.add('btn-success');
        demo_button.classList.remove('btn-danger');
        is_running = false;
      } else {
        //window.addEventListener("devicemotion", handleMotion);
        window.addEventListener("deviceorientation", handleOrientation);
        document.getElementById("start_demo").innerHTML = "Stop demo";
        demo_button.classList.remove('btn-success');
        demo_button.classList.add('btn-danger');
        is_running = true;
      }
    };
  </script>
</body>

</html>

